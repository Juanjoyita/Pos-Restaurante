<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caja - {{ dia }}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #ddd; padding:12px; border-radius:8px; margin:10px 0; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align:left; }
    th { background:#fafafa; }
    .right { text-align:right; }
    .muted { color:#666; font-size: 12px; }
    a.btn, button.btn {
      border:1px solid #333; background:#eee; padding:10px 12px; border-radius:6px;
      text-decoration:none; color:#000; cursor:pointer;
    }
    input { padding:10px 12px; border-radius:6px; border:1px solid #ccc; }
  </style>
</head>
<body>

  <div class="topbar">
    <h1 style="margin:0;">üìä Caja del d√≠a</h1>
    <a class="btn" href="{{ url_for('admin_panel') }}">‚Ü©Ô∏è Volver</a>
    <a class="btn" href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>

    <form method="GET" action="{{ url_for('caja_dia') }}" style="display:flex; gap:8px; align-items:center;">
  <label class="muted">Fecha:</label>

  <select name="fecha" style="padding:10px 12px; border-radius:6px; border:1px solid #ccc;">
    {% for f in fechas_disponibles %}
      <option value="{{ f }}" {% if f == dia|string %}selected{% endif %}>
        {{ f }}
      </option>
    {% endfor %}
  </select>

  <button class="btn" type="submit">Ver</button>
</form>

  </div>

  <div class="card grid">
    <div>
      <div class="muted">Fecha</div>
      <div><b>{{ dia }}</b></div>
    </div>
    <div>
      <div class="muted">Total vendido</div>
      <div><b>{{ total_dia|cop }}</b></div>
    </div>
    <div>
      <div class="muted">Pedidos cobrados</div>
      <div><b>{{ conteo }}</b></div>
    </div>
    <div>
      <div class="muted">Ticket promedio</div>
      <div><b>{{ ticket_promedio|cop }}</b></div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">üí≥ Ventas por m√©todo de pago</h2>
    <table>
      <thead>
        <tr>
          <th>M√©todo</th>
          <th class="right">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Efectivo</td><td class="right">{{ por_metodo["efectivo"]|cop }}</td></tr>
        <tr><td>Transferencia</td><td class="right">{{ por_metodo["transferencia"]|cop }}</td></tr>
        <tr><td>Tarjeta</td><td class="right">{{ por_metodo["tarjeta"]|cop }}</td></tr>
        <tr><td>Otro</td><td class="right">{{ por_metodo["otro"]|cop }}</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">üßæ Pedidos cobrados ({{ dia }})</h2>
    {% if pedidos_info|length == 0 %}
      <p>No hay pedidos cobrados en esta fecha.</p>
    {% else %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Mesa</th>
            <th>Hora</th>
            <th>M√©todo</th>
            <th class="right">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for p in pedidos_info %}
          <tr>
            <td>#{{ p.id }}</td>
            <td>{{ p.mesa }}</td>
            <td>{{ p.hora }}</td>
            <td>{{ p.metodo }}</td>
            <td class="right">{{ p.total|cop }}</td>
            <td><a class="btn" href="{{ url_for('ver_factura', pedido_id=p.id) }}">Ver</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <div class="card">
    <h2 style="margin-top:0;">üî• Top productos (por ventas)</h2>
    {% if top_lista|length == 0 %}
      <p>No hay productos (a√∫n).</p>
    {% else %}
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th class="right">Cantidad</th>
            <th class="right">Ventas</th>
          </tr>
        </thead>
        <tbody>
          {% for t in top_lista %}
          <tr>
            <td>{{ t.nombre }}</td>
            <td class="right">{{ t.cantidad }}</td>
            <td class="right">{{ t.ventas|cop }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    <div class="card">
  <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:end;">
    <div>
      <h2 style="margin:0;">üìä Ventas</h2>
      <div class="muted" id="txtPromedio" style="margin-top:4px;"></div>
    </div>

    <form id="filtroGrafica" style="display:flex; gap:8px; flex-wrap:wrap; align-items:end;">
      <div>
        <div class="muted">Vista</div>
        <select id="granularity" style="padding:10px 12px; border-radius:6px; border:1px solid #ccc;">
          <option value="day">Diario</option>
          <option value="month">Mensual</option>
        </select>
      </div>

      <div>
        <div class="muted">Desde</div>
        <input id="fromDate" type="date" style="padding:10px 12px; border-radius:6px; border:1px solid #ccc;">
      </div>

      <div>
        <div class="muted">Hasta</div>
        <input id="toDate" type="date" style="padding:10px 12px; border-radius:6px; border:1px solid #ccc;">
      </div>

      <button class="btn" type="submit">Aplicar</button>
      <button class="btn" id="btnReset" type="button">Reset</button>
    </form>
  </div>

  <div style="margin-top:12px;">
    <canvas id="chartVentas" height="110"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartRef = null;

  function moneyCO(v){
    return "$" + Math.round(v).toLocaleString("es-CO");
  }

  function buildParams(){
    const gran = document.getElementById("granularity").value;
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    const params = new URLSearchParams();
    params.set("granularity", gran);
    if (from) params.set("from", from);
    if (to) params.set("to", to);
    return params.toString();
  }

  async function cargarGrafica(){
    const qs = buildParams();
    const res = await fetch(`/admin/caja/resumen.json?${qs}`, { cache: "no-store" });
    if (!res.ok) {
      document.getElementById("txtPromedio").textContent = "No se pudo cargar la gr√°fica.";
      return;
    }

    const data = await res.json();
    const labels = data.labels || [];
    const values = data.values || [];
    const promedio = data.promedio || 0;

    const gran = document.getElementById("granularity").value;
    document.getElementById("txtPromedio").textContent =
      (values.length ? `Promedio ${gran === "month" ? "mensual" : "diario"}: ${moneyCO(promedio)}` : "Sin datos en el rango.");

    const ctx = document.getElementById("chartVentas");
    if (!ctx) return;

    // destruir si ya existe
    if (chartRef) {
      chartRef.destroy();
      chartRef = null;
    }

    chartRef = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: gran === "month" ? "Ventas mensuales" : "Ventas diarias",
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${moneyCO(c.raw)}`
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (v) => moneyCO(v)
            }
          }
        }
      }
    });
  }

  // eventos
  document.getElementById("filtroGrafica").addEventListener("submit", (e) => {
    e.preventDefault();
    cargarGrafica();
  });

  document.getElementById("btnReset").addEventListener("click", () => {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    document.getElementById("granularity").value = "day";
    cargarGrafica();
  });

  // cargar al abrir
  cargarGrafica();
</script>

  </div>

</body>
</html>
